#!/usr/bin/env php
<?php

if ( 'cli' !== PHP_SAPI )
{
    echo 'Warning: Slicer should be invoked via the CLI version of PHP, not the ' . PHP_SAPI . ' SAPI' . PHP_EOL;
}

require __DIR__ . '/../src/bootstrap.php';

use Slicer\Console\Application;

error_reporting( -1 );

if ( function_exists( 'ini_set' ) )
{
    @ini_set( 'display_errors', 1 );

    $memoryInBytes = function ( $value )
    {
        $unit  = strtolower( substr( $value, -1, 1 ) );
        $value = ( int ) $value;

        switch ( $unit )
        {
            case 'g':
                $value *= 1024;
            // no break ( cumulative multiplier )
            case 'm':
                $value *= 1024;
            // no break ( cumulative multiplier )
            case 'k':
                $value *= 1024;
        }

        return $value;
    };

    $memoryLimit = trim( ini_get( 'memory_limit' ) );

    // Increase memory_limit if it is lower then 1GB

    if ( -1 != $memoryLimit && $memoryInBytes( $memoryLimit ) < 1024 * 1024 * 1024 )
    {
        @ini_set( 'memory_limit', '1G' );
    }

    unset( $memoryInBytes, $memoryLimit );
}

if ( !function_exists( 'base_path' ) )
{
    /**
     * Get the path to the base of the install.
     *
     * @param  string $path
     *
     * @return string
     */
    function base_path( $path = '' )
    {
        $dir = ( isset( $_SERVER[ 'PWD' ] ) ? $_SERVER[ 'PWD' ] : __DIR__ . '/../' );

        return strtr( str_replace( [ 'phar://', 'update.phar' ], '', $dir ) . ( $path ? DIRECTORY_SEPARATOR . $path : $path ), '\\', '/' );
    }
}

putenv( 'SLICER_HOME=' . __DIR__ );
putenv( 'SLICER=' . base_path( 'slicer.json' ) );

// run the command application
$app = new Application();
$app->run();

/**
 * Returns the application configuration array.
 *
 * @return array
 */
function get_slicer_config()
{
    $file = base_path( 'slicer.json' );

    if ( file_exists( $file ) )
    {
        return json_decode( file_get_contents( $file ), TRUE );
    }
    else
    {
        echo PHP_EOL . 'Unable to find "slicer.json". Are you sure you are in the root directory?' . PHP_EOL;

        exit( 1 );
    }
}